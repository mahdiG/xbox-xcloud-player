var xCloudPlayer;(()=>{"use strict";var e={370:e=>{var t,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,i){function s(n){e.removeListener(t,o),i(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",s),n([].slice.call(arguments))}v(e,t,o,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&v(e,"error",t,{once:!0})}(e,s)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var r=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function d(e,t,n,i){var s,o,r,d;if(a(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),r=o[t]),void 0===r)r=o[t]=n,++e._eventsCount;else if("function"==typeof r?r=o[t]=i?[n,r]:[r,n]:i?r.unshift(n):r.push(n),(s=l(e))>0&&r.length>s&&!r.warned){r.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=r.length,d=h,console&&console.warn&&console.warn(d)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=h.bind(i);return s.listener=n,i.wrapFn=s,s}function c(e,t,n){var i=e._events;if(void 0===i)return[];var s=i[t];return void 0===s?[]:"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):m(s,s.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function m(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function v(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(o){i.once&&e.removeEventListener(t,s),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");r=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,o=this._events;if(void 0!==o)s=s&&void 0===o.error;else if(!s)return!1;if(s){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var a=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)i(l,this,t);else{var d=l.length,h=m(l,d);for(n=0;n<d;++n)i(h[n],this,t)}return!0},o.prototype.addListener=function(e,t){return d(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return d(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,i,s,o,r;if(a(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){r=n[o].listener,s=o;break}if(s<0)return this;0===s?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,s),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,r||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var s,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(s=o[i])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},o.prototype.listeners=function(e){return c(this,e,!0)},o.prototype.rawListeners=function(e){return c(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},488:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t){this._events={state:[]},this._channelName=e,this._client=t,this._state="new"}onOpen(e){console.log("xCloudPlayer Channels/Base.ts - ["+this._channelName+"] onOpen:",e),this.setState("connected")}onClosing(e){console.log("xCloudPlayer Channel/Base.ts - ["+this._channelName+"] onClosing:",e),this.setState("closing")}onClose(e){console.log("xCloudPlayer Channel/Base.ts - ["+this._channelName+"] onClose:",e),this.setState("closed")}destroy(){}setState(e){this._state=e,this.emitEvent("state",{state:this._state})}send(e){const t=this.getClient().getChannel(this._channelName);"open"===t.readyState?("input"!==this._channelName&&"chat"!==this._channelName&&console.log("xCloudPlayer Channel/Base.ts - ["+this._channelName+"] Sending message:",e),"string"==typeof e&&(e=(new TextEncoder).encode(e)),t.send(e)):console.warn("xCloudPlayer Channel/Base.ts - ["+this._channelName+"] Channel is closed. Failed to send packet:",e)}getClient(){return this._client}addEventListener(e,t){this._events[e].push(t)}emitEvent(e,t){for(const n in this._events[e])this._events[e][n](t)}}},223:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(488));class o extends s.default{constructor(){super(...arguments),this.isCapturing=!1,this.isPaused=!0}onOpen(e){super.onOpen(e)}start(){}onMessage(e){console.log("xCloudPlayer Channel/Chat.ts - ["+this._channelName+"] onMessage:",e);const t=JSON.parse(e.data);console.log("xCloudPlayer Channel/Chat.ts - Received json:",t)}onClose(e){super.onClose(e)}startMic(){console.log("xCloudPlayer Channel/Chat.ts - Enabling Microphone"),!1===this.isCapturing&&(console.log("Start chat..."),navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:24e3}}).then((e=>{this.isCapturing=!0;const t=e.getAudioTracks();t.length>0?console.log(`Using Audio device: ${t[0].label}`):console.log("No Audio device:",t),e.getTracks().forEach((t=>{this._client._webrtcClient.addTrack(t,e)})),this._client.sdpNegotiationChat()})).catch((e=>{alert(`getUserMedia() error: ${e.name}`),this.isCapturing=!1}))),this.isPaused=!1}stopMic(){var e;console.log("xCloudPlayer Channel/Chat.ts - Disabling Microphone");const t=this._client._webrtcClient.getSenders();for(const n in t)null!==t[n].track&&"audio"===(null===(e=t[n].track)||void 0===e?void 0:e.kind)&&this._client._webrtcClient.removeTrack(t[n]);this.isCapturing=!1,this.isPaused=!0}}t.default=o},91:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(488));class o extends s.default{onOpen(e){super.onOpen(e)}start(){const e=JSON.stringify({message:"authorizationRequest",accessKey:"4BDB3609-C1F1-4195-9B37-FEFF45DA8B8E"});this.send(e);const t=JSON.stringify({message:"gamepadChanged",gamepadIndex:0,wasAdded:!0});this.send(t)}onMessage(e){console.log("xCloudPlayer Channel/Control.ts - ["+this._channelName+"] onMessage:",e);const t=JSON.parse(e.data);console.log("xCloudPlayer Channel/Control.ts - Received json:",t)}onClose(e){super.onClose(e)}requestKeyframeRequest(){console.log("xCloudPlayer Channel/Control.ts - ["+this._channelName+"] User requested Video KeyFrame");const e=JSON.stringify({message:"videoKeyframeRequested",ifrRequested:!0});this.send(e)}}t.default=o},272:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(758)),o=i(n(488)),r=i(n(269));class a extends o.default{constructor(e,t){super(e,t),this._inputSequenceNum=0,this._reportTypes={None:0,Metadata:1,Gamepad:2,Pointer:4,ClientMetadata:8,ServerMetadata:16,Mouse:32,Keyboard:64,Vibration:128,Sendor:256},this._frameMetadataQueue=[],this._gamepadFrames=[],this._pointerFrames=[],this._pointerCounter=1,this._mouseFrames=[],this._keyboardFrames=[],this._keyboardEvents=[],this._rumbleEnabled=!0,this._touchEvents={},this._touchLastPointerId=0,this._mouseActive=!1,this._mouseLocked=!1,this._touchActive=!1,this._mouseStateButtons=0,this._mouseStateX=0,this._mouseStateY=0,this._keyboardButtonsState={},this._metadataFps=new s.default(this.getClient(),"metadata"),this._inputFps=new s.default(this.getClient(),"input")}onOpen(e){super.onOpen(e),this._metadataFps.start(),this._inputFps.start()}start(){const e=new r.default(this._inputSequenceNum);e.setMetadata(2),this.send(e.toBuffer()),!1===this._client._config.input_legacykeyboard&&this.getClient()._inputDriver.run(),this._inputInterval=setInterval((()=>{if(!0===this._client._config.input_legacykeyboard&&0===this.getGamepadQueueLength()){const e=this.getClient()._inputDriver.requestState(),t=this.getClient()._keyboardDriver.requestState(),n=this.mergeState(e,t,this._adhocState);this._adhocState=null,this.queueGamepadState(n)}if(!0===this._client._config.input_touch&&Object.keys(this._touchEvents).length>0){for(const e in this._touchEvents)this._pointerFrames.push({events:this._touchEvents[e].events});this._touchEvents={}}const e=this.getMetadataQueue(),t=this.getGamepadQueue(),n=this.getPointerQueue(),i=this.getMouseQueue(),s=this.getKeyboardQueue();if(0!==e.length||0!==t.length||0!==n.length){this._inputSequenceNum++;const o=new r.default(this._inputSequenceNum);o.setData(e,t,n,i,s),this.send(o.toBuffer())}}),16)}mergeState(e,t,n){var i,s,o,r,a,l,d,h,u,c,p,m,v,_,g,f,y,b,C,w,P,x,S,L,k,T,M,D,A,I,R,E,O,U,B,F,N,V,j;return{GamepadIndex:null!==(i=null==e?void 0:e.GamepadIndex)&&void 0!==i?i:t.GamepadIndex,A:Math.max(null!==(s=null==e?void 0:e.A)&&void 0!==s?s:0,t.A,null!==(o=null==n?void 0:n.A)&&void 0!==o?o:0),B:Math.max(null!==(r=null==e?void 0:e.B)&&void 0!==r?r:0,t.B,null!==(a=null==n?void 0:n.B)&&void 0!==a?a:0),X:Math.max(null!==(l=null==e?void 0:e.X)&&void 0!==l?l:0,t.X,null!==(d=null==n?void 0:n.X)&&void 0!==d?d:0),Y:Math.max(null!==(h=null==e?void 0:e.Y)&&void 0!==h?h:0,t.Y,null!==(u=null==n?void 0:n.Y)&&void 0!==u?u:0),LeftShoulder:Math.max(null!==(c=null==e?void 0:e.LeftShoulder)&&void 0!==c?c:0,t.LeftShoulder,null!==(p=null==n?void 0:n.LeftShoulder)&&void 0!==p?p:0),RightShoulder:Math.max(null!==(m=null==e?void 0:e.RightShoulder)&&void 0!==m?m:0,t.RightShoulder,null!==(v=null==n?void 0:n.RightShoulder)&&void 0!==v?v:0),LeftTrigger:Math.max(null!==(_=null==e?void 0:e.LeftTrigger)&&void 0!==_?_:0,t.LeftTrigger,null!==(g=null==n?void 0:n.LeftTrigger)&&void 0!==g?g:0),RightTrigger:Math.max(null!==(f=null==e?void 0:e.RightTrigger)&&void 0!==f?f:0,t.RightTrigger,null!==(y=null==n?void 0:n.RightTrigger)&&void 0!==y?y:0),View:Math.max(null!==(b=null==e?void 0:e.View)&&void 0!==b?b:0,t.View,null!==(C=null==n?void 0:n.View)&&void 0!==C?C:0),Menu:Math.max(null!==(w=null==e?void 0:e.Menu)&&void 0!==w?w:0,t.Menu,null!==(P=null==n?void 0:n.Menu)&&void 0!==P?P:0),LeftThumb:Math.max(null!==(x=null==e?void 0:e.LeftThumb)&&void 0!==x?x:0,t.LeftThumb,null!==(S=null==n?void 0:n.LeftThumb)&&void 0!==S?S:0),RightThumb:Math.max(null!==(L=null==e?void 0:e.RightThumb)&&void 0!==L?L:0,t.RightThumb,null!==(k=null==n?void 0:n.RightThumb)&&void 0!==k?k:0),DPadUp:Math.max(null!==(T=null==e?void 0:e.DPadUp)&&void 0!==T?T:0,t.DPadUp,null!==(M=null==n?void 0:n.DPadUp)&&void 0!==M?M:0),DPadDown:Math.max(null!==(D=null==e?void 0:e.DPadDown)&&void 0!==D?D:0,t.DPadDown,null!==(A=null==n?void 0:n.DPadDown)&&void 0!==A?A:0),DPadLeft:Math.max(null!==(I=null==e?void 0:e.DPadLeft)&&void 0!==I?I:0,t.DPadLeft,null!==(R=null==n?void 0:n.DPadLeft)&&void 0!==R?R:0),DPadRight:Math.max(null!==(E=null==e?void 0:e.DPadRight)&&void 0!==E?E:0,t.DPadRight,null!==(O=null==n?void 0:n.DPadRight)&&void 0!==O?O:0),Nexus:Math.max(null!==(U=null==e?void 0:e.Nexus)&&void 0!==U?U:0,t.Nexus,null!==(B=null==n?void 0:n.Nexus)&&void 0!==B?B:0),LeftThumbXAxis:this.mergeAxix(null!==(F=null==e?void 0:e.LeftThumbXAxis)&&void 0!==F?F:0,t.LeftThumbXAxis),LeftThumbYAxis:this.mergeAxix(null!==(N=null==e?void 0:e.LeftThumbYAxis)&&void 0!==N?N:0,t.LeftThumbYAxis),RightThumbXAxis:this.mergeAxix(null!==(V=null==e?void 0:e.RightThumbXAxis)&&void 0!==V?V:0,t.RightThumbXAxis),RightThumbYAxis:this.mergeAxix(null!==(j=null==e?void 0:e.RightThumbYAxis)&&void 0!==j?j:0,t.RightThumbYAxis)}}mergeAxix(e,t){return Math.abs(e)>Math.abs(t)?e:t}onMessage(e){var t;const n=new DataView(e.data);let i=0;const s=n.getUint8(i);if(n.getUint8(i+1),i+=2,s===this._reportTypes.Vibration){n.getUint8(i),n.getUint8(i+1),i+=2;const e=n.getUint8(i)/100,s=n.getUint8(i+1)/100,o=n.getUint8(i+2)/100,r=n.getUint8(i+3)/100,a=n.getUint16(i+4,!0),l=n.getUint16(i+6,!0),d=n.getUint8(i+8);i+=9;const h=navigator.getGamepads()[0];if(null!==h&&!0===this._rumbleEnabled){const n={startDelay:0,duration:a,weakMagnitude:s,strongMagnitude:e,leftTrigger:o,rightTrigger:r};if(void 0!==this._rumbleInterval&&clearInterval(this._rumbleInterval),void 0!==h.vibrationActuator){if("dual-rumble"===h.vibrationActuator.type){const e=s<.6?(.6-s)/2:0,t=(o+r)/4,i=Math.min(e,t);n.weakMagnitude=Math.min(1,s+i),n.leftTrigger=0,n.rightTrigger=0}if(null===(t=h.vibrationActuator)||void 0===t||t.playEffect(h.vibrationActuator.type,n),d>0){let e=d;this._rumbleInterval=setInterval((()=>{var t;e<=0&&clearInterval(this._rumbleInterval),void 0!==h.vibrationActuator&&(null===(t=h.vibrationActuator)||void 0===t||t.playEffect(h.vibrationActuator.type,n)),e--}),l+a)}}}}}onClose(e){clearInterval(this._inputInterval),super.onClose(e)}_createInputPacket(e,t,n,i,s,o){this._inputSequenceNum++;const a=new r.default(this._inputSequenceNum);return a.setData(t,n,i,s,o),a.toBuffer()}getGamepadQueue(e=30){return this._gamepadFrames.splice(0,e-1)}getGamepadQueueLength(){return this._gamepadFrames.length}queueGamepadState(e){if(null!==e)return this._gamepadFrames.push(e)}getPointerQueue(e=2){return this._pointerFrames.splice(0,e-1)}getPointerQueueLength(){return this._pointerFrames.length}getMouseQueue(e=30){return this._mouseFrames.splice(0,e-1)}getMouseQueueLength(){return this._mouseFrames.length}getKeyboardQueue(e=2){return this._keyboardFrames.splice(0,e-1)}getKeyboardQueueLength(){return this._keyboardFrames.length}onPointerMove(e){e.preventDefault(),!0===this._mouseActive&&!0===this._mouseLocked&&(this._mouseStateX=e.movementX,this._mouseStateY=e.movementY,this._mouseStateButtons=e.buttons,this._mouseFrames.push({X:10*this._mouseStateX,Y:10*this._mouseStateY,WheelX:0,WheelY:0,Buttons:this._mouseStateButtons,Relative:0})),!0===this._touchActive&&(this._touchLastPointerId=e.pointerId,void 0===this._touchEvents[e.pointerId]&&(this._touchEvents[e.pointerId]={events:[]}),this._touchEvents[e.pointerId].events.push(e))}requestPointerLockWithUnadjustedMovement(e){const t=e.requestPointerLock({unadjustedMovement:!0});return"keyboard"in navigator&&"lock"in navigator.keyboard&&document.body.requestFullscreen().then((()=>{navigator.keyboard.lock()})),t.then((()=>{console.log("pointer is locked"),this._mouseLocked=!0})).catch((t=>{if("NotSupportedError"===t.name)return this._mouseLocked=!0,e.requestPointerLock()}))}onPointerClick(e){e.preventDefault(),"touch"===e.pointerType?(this._mouseActive=!1,this._touchActive=!0):"mouse"===e.pointerType&&(this._mouseActive=!0,this._touchActive=!1),!0===this._client._config.input_mousekeyboard&&!0===this._mouseActive&&!1===this._mouseLocked?(this.requestPointerLockWithUnadjustedMovement(e.target),document.addEventListener("pointerlockchange",(()=>{null!==document.pointerLockElement?this._mouseLocked=!0:this._mouseLocked=!1}),!1),document.addEventListener("systemkeyboardlockchanged",(e=>{console.log(e)}),!1)):!0===this._mouseActive&&!0===this._mouseLocked&&(this._mouseStateX=e.movementX,this._mouseStateY=e.movementY,this._mouseStateButtons=e.buttons,this._mouseFrames.push({X:10*this._mouseStateX,Y:10*this._mouseStateY,WheelX:0,WheelY:0,Buttons:this._mouseStateButtons,Relative:0})),!0===this._touchActive&&(this._touchLastPointerId=e.pointerId,void 0===this._touchEvents[e.pointerId]&&(this._touchEvents[e.pointerId]={events:[]}),this._touchEvents[e.pointerId].events.push(e))}onPointerScroll(e){e.preventDefault()}onKeyDown(e){!0===this._mouseActive&&!0===this._mouseLocked&&!0!==this._keyboardButtonsState[e.keyCode]&&(this._keyboardButtonsState[e.keyCode]=!0,this._keyboardFrames.push({pressed:!0,key:e.key,keyCode:e.keyCode}),setTimeout((()=>{this._keyboardFrames.push({pressed:!0,key:e.key,keyCode:e.keyCode})}),16))}onKeyUp(e){!0===this._mouseActive&&!0===this._mouseLocked&&(this._keyboardButtonsState[e.keyCode]=!1,this._keyboardFrames.push({pressed:!1,key:e.key,keyCode:e.keyCode}),setTimeout((()=>{this._keyboardFrames.push({pressed:!1,key:e.key,keyCode:e.keyCode})}),16))}convertAbsoluteMousePositionImpl(e,t,n,i){let s=n,o=i;const r=1920/1080;return r>n/i?(o=s/r,t-=(i-o)/2):(s=o*r,e-=(n-s)/2),e*=65535/s,t*=65535/o,[e=Math.min(Math.max(Math.round(e),0),65535),t=Math.min(Math.max(Math.round(t),0),65535)]}_convertToInt16(e){const t=new Int16Array(1);return t[0]=e,t[0]}_convertToUInt16(e){const t=new Uint16Array(1);return t[0]=e,t[0]}normalizeTriggerValue(e){if(e<0)return this._convertToUInt16(0);const t=65535*e,n=t>65535?65535:t;return this._convertToUInt16(n)}normalizeAxisValue(e){const t=this._convertToInt16(32767),n=this._convertToInt16(-32767),i=e*t;return i>t?t:i<n?n:this._convertToInt16(i)}pressButton(e,t){!0===this._client._config.input_legacykeyboard?this._client._keyboardDriver.pressButton(t):this._client._inputDriver.pressButton(e,t)}setInput(e){this._client._inputDriver.setInput(e)}destroy(){this._metadataFps.stop(),this._inputFps.stop(),clearInterval(this._inputInterval),super.destroy()}addProcessedFrame(e){e.frameRenderedTimeMs=performance.now(),this._frameMetadataQueue.push(e)}getMetadataQueue(e=30){return this._frameMetadataQueue.splice(0,e-1)}getMetadataQueueLength(){return this._frameMetadataQueue.length}}t.default=a},269:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.None=0]="None",e[e.Metadata=1]="Metadata",e[e.Gamepad=2]="Gamepad",e[e.Pointer=4]="Pointer",e[e.ClientMetadata=8]="ClientMetadata",e[e.ServerMetadata=16]="ServerMetadata",e[e.Mouse=32]="Mouse",e[e.Keyboard=64]="Keyboard",e[e.Vibration=128]="Vibration",e[e.Sensor=256]="Sensor"}(n||(n={})),t.default=class{constructor(e){this._reportType=n.None,this._totalSize=-1,this._sequence=-1,this._metadataFrames=[],this._gamepadFrames=[],this._pointerFrames=[],this._mouseFrames=[],this._keyboardFrames=[],this._maxTouchpoints=0,this._sequence=e}setMetadata(e=1){this._reportType=n.ClientMetadata,this._totalSize=15,this._maxTouchpoints=e}setData(e,t,i,s,o){let r=14;e.length>0&&(this._reportType|=n.Metadata,r+=this._calculateMetadataSize(e),this._metadataFrames=e),t.length>0&&(this._reportType|=n.Gamepad,r+=this._calculateGamepadSize(t),this._gamepadFrames=t),i.length>0&&(this._reportType|=n.Pointer,r+=this._calculatePointerSize(i),this._pointerFrames=i),s.length>0&&(this._reportType|=n.Mouse,r+=this._calculateMouseSize(s),this._mouseFrames=s),o.length>0&&(this._reportType|=n.Keyboard,r+=this._calculateKeyboardSize(o),this._keyboardFrames=o),this._totalSize=r}_calculateMetadataSize(e){return 1+28*e.length}_calculateGamepadSize(e){return 1+23*e.length}_calculatePointerSize(e){let t=1;for(const n in e)t=t+1+20*e[n].events.length;return t}_calculateMouseSize(e){return 1+18*e.length}_calculateKeyboardSize(e){return 1+3*e.length}_writeMetadataData(e,t,n){for(e.setUint8(t,n.length),t++,n.length>=30&&console.warn("metadataQueue is bigger then 30. This might impact reliability!");n.length>0;){const i=n.shift(),s=i.firstFramePacketArrivalTimeMs,o=i.frameSubmittedTimeMs,r=i.frameDecodedTimeMs,a=i.frameRenderedTimeMs,l=performance.now(),d=performance.now();e.setUint32(t,i.serverDataKey,!0),e.setUint32(t+4,s,!0),e.setUint32(t+8,o,!0),e.setUint32(t+12,r,!0),e.setUint32(t+16,a,!0),e.setUint32(t+20,l,!0),e.setUint32(t+24,d,!0),t+=28}return t}_writeGamepadData(e,t,n){for(e.setUint8(t,n.length),t++,n.length>=30&&console.warn("gamepadQueue is bigger then 30. This might impact reliability!");n.length>0;){const i=n.shift();if(void 0!==i){const n=i;e.setUint8(t,n.GamepadIndex),t++;let s=0;n.Nexus>0&&(s|=2),n.Menu>0&&(s|=4),n.View>0&&(s|=8),n.A>0&&(s|=16),n.B>0&&(s|=32),n.X>0&&(s|=64),n.Y>0&&(s|=128),n.DPadUp>0&&(s|=256),n.DPadDown>0&&(s|=512),n.DPadLeft>0&&(s|=1024),n.DPadRight>0&&(s|=2048),n.LeftShoulder>0&&(s|=4096),n.RightShoulder>0&&(s|=8192),n.LeftThumb>0&&(s|=16384),n.RightThumb>0&&(s|=32768),e.setUint16(t,s,!0),e.setInt16(t+2,this._normalizeAxisValue(n.LeftThumbXAxis),!0),e.setInt16(t+4,this._normalizeAxisValue(-n.LeftThumbYAxis),!0),e.setInt16(t+6,this._normalizeAxisValue(n.RightThumbXAxis),!0),e.setInt16(t+8,this._normalizeAxisValue(-n.RightThumbYAxis),!0),e.setUint16(t+10,this._normalizeTriggerValue(n.LeftTrigger),!0),e.setUint16(t+12,this._normalizeTriggerValue(n.RightTrigger),!0),e.setUint32(t+14,0,!0),e.setUint32(t+18,0,!1),t+=22}}return t}_writePointerData(e,t,n){e.setUint8(t,1),t++,n.length>=2&&console.warn("pointerQueue is bigger then 1. Only one event will be sent.");const i=n.shift();if(void 0!==i){e.setUint8(t,i.events.length),t++;const n=3840,s=2160;for(const o in i.events){const r=i.events[o].target.getBoundingClientRect();let a=s/1*.06575749909301447,l=n/1*.06575749909301447;a=1,l=1,"pointerup"===i.events[o].type&&(a=0,l=0),e.setUint16(t,a,!0),e.setUint16(t+2,l,!0),e.setUint8(t+4,255*i.events[o].pressure),e.setUint16(t+5,i.events[o].twist,!0),e.setUint32(t+7,0,!0);let d=(i.events[o].x-r.left)*(n/r.width),h=(i.events[o].y-r.top)*(s/r.height);"pointerup"===i.events[o].type&&(d=0,h=0),e.setUint32(t+11,d,!0),e.setUint32(t+15,h,!0),e.setUint8(t+19,"pointerdown"===i.events[o].type?1:"pointerup"===i.events[o].type?2:"pointermove"===i.events[o].type?3:0),t+=20}}return t}_writeMouseData(e,t,n){for(e.setUint8(t,n.length),t++,n.length>=30&&console.warn("mouseQueue is bigger then 30. This might impact reliability!");n.length>0;){const i=n.shift();if(void 0!==i){const n=i;e.setUint32(t,n.X,!0),e.setUint32(t+4,n.Y,!0),e.setUint32(t+8,n.WheelX,!0),e.setUint32(t+12,n.WheelY,!0),e.setUint8(t+16,n.Buttons),e.setUint8(t+17,n.Relative),t+=18}}return t}_writeKeyboardData(e,t,n){for(e.setUint8(t,n.length),t++,n.length>=30&&console.warn("keyboardQueue is bigger then 30. This might impact reliability!");n.length>0;){const i=n.shift();if(void 0!==i){const n=i;e.setUint8(t,2),e.setUint8(t+1,n.pressed?1:0),e.setUint8(t+2,n.keyCode),t+=3}}return t}toBuffer(){const e=new Uint8Array(this._totalSize),t=new DataView(e.buffer);t.setUint16(0,this._reportType,!0),t.setUint32(2,this._sequence,!0),t.setFloat64(6,performance.now(),!0);let i=14;if(this._metadataFrames.length>0&&(i=this._writeMetadataData(t,i,this._metadataFrames)),this._gamepadFrames.length>0&&(i=this._writeGamepadData(t,i,this._gamepadFrames)),this._pointerFrames.length>0&&(i=this._writePointerData(t,i,this._pointerFrames)),this._mouseFrames.length>0&&(i=this._writeMouseData(t,i,this._mouseFrames)),this._keyboardFrames.length>0&&(i=this._writeKeyboardData(t,i,this._keyboardFrames)),this._reportType===n.ClientMetadata&&(t.setUint8(i,this._maxTouchpoints),i++),i!=i)throw new Error("Packet length mismatch. Something is wrong!");return t}_normalizeTriggerValue(e){if(e<0)return this._convertToUInt16(0);const t=65535*e,n=t>65535?65535:t;return this._convertToUInt16(n)}_normalizeAxisValue(e){const t=this._convertToInt16(32767),n=this._convertToInt16(-32767),i=e*t;return i>t?t:i<n?n:this._convertToInt16(i)}_convertToInt16(e){const t=new Int16Array(1);return t[0]=e,t[0]}_convertToUInt16(e){const t=new Uint16Array(1);return t[0]=e,t[0]}}},187:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(488));class o extends s.default{onOpen(e){super.onOpen(e);const t=JSON.stringify({type:"Handshake",version:"messageV1",id:"f9c5f412-0e69-4ede-8e62-92c7f5358c56",cv:""});this.send(t)}onMessage(e){console.log("xCloudPlayer Channel/Message.ts - ["+this._channelName+"] onMessage:",e);const t=JSON.parse(e.data);if(console.log("xCloudPlayer Channel/Message.ts - Received json:",t),"HandshakeAck"===t.type){this.getClient().getChannelProcessor("control").start(),this.getClient().getChannelProcessor("input").start();const e=this.getClient()._config.ui_systemui||[10,19,31,27,32,-41],t=this.getClient()._config.ui_version||[0,1,0],n=JSON.stringify(this.generateMessage("/streaming/systemUi/configuration",{version:t,systemUis:e}));this.send(n);const i=JSON.stringify(this.generateMessage("/streaming/properties/clientappinstallidchanged",{clientAppInstallId:"c11ddb2e-c7e3-4f02-a62b-fd5448e0b851"}));this.send(i);const s=JSON.stringify(this.generateMessage("/streaming/characteristics/orientationchanged",{orientation:0}));this.send(s);const o=JSON.stringify(this.generateMessage("/streaming/characteristics/touchinputenabledchanged",{touchInputEnabled:this.getClient()._config.input_touch}));this.send(o);const r=JSON.stringify(this.generateMessage("/streaming/characteristics/clientdevicecapabilities",{}));this.send(r);const a=JSON.stringify(this.generateMessage("/streaming/characteristics/dimensionschanged",{horizontal:1920,vertical:1080,preferredWidth:1920,preferredHeight:1080,safeAreaLeft:0,safeAreaTop:0,safeAreaRight:1920,safeAreaBottom:1080,supportsCustomResolution:!0}));this.send(a)}this.getClient().getEventBus().emit("message",{...t})}onClose(e){super.onClose(e)}generateMessage(e,t){return{type:"Message",content:JSON.stringify(t),id:"41f93d5a-900f-4d33-b7a1-2d4ca6747072",target:e,cv:""}}sendTransaction(e,t){const n=JSON.stringify({type:"TransactionComplete",content:JSON.stringify(t),id:e,cv:""});this.send(n)}}t.default=o},191:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this._client=e}create(e){console.log("xCloudPlayer Component/Audio.ts - Create media element");const t=document.getElementById(this._client._elementHolder);if(null!==t){const n=document.createElement("audio");n.id=this.getElementId(),n.srcObject=e,n.autoplay=!0,this._audioRender=n,t.appendChild(n)}else console.log("xCloudPlayer Component/Audio.ts - Error fetching audioholder: div#"+this._client._elementHolder);console.log("xCloudPlayer Component/Audio.ts - Media element created")}getElementId(){return"xCloudPlayer_"+this._client._elementHolderRandom+"_audioRender"}getSource(){return this._audioSource}createMediaSource(){const e=new MediaSource,t=window.URL.createObjectURL(e);return e.addEventListener("sourceopen",(()=>{console.log("xCloudPlayer Component/Audio.ts - MediaSource opened. Attaching audioSourceBuffer...");let t="audio/webm;codecs=opus";this._isSafari()&&(t="audio/mp4");const n=e.addSourceBuffer(t);n.mode="sequence",n.addEventListener("error",(e=>{console.log("xCloudPlayer Component/Audio.ts - Error audio...",e)})),this._audioSource=n})),this._mediaSource=e,t}destroy(){var e;delete this._mediaSource,delete this._audioRender,delete this._audioSource,null===(e=document.getElementById(this.getElementId()))||void 0===e||e.remove(),console.log("xCloudPlayer Component/Audio.ts - Cleaning up audio element")}_isSafari(){return navigator.userAgent.search("Safari")>=0&&navigator.userAgent.search("Chrome")<0}}},684:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(758));t.default=class{constructor(e){this._client=e}create(e){console.log("xCloudPlayer Component/Video.ts - Create media element"),this._videoFps=new s.default(this._client,"video");const t=document.getElementById(this._client._elementHolder);if(null!==t){const n=document.createElement("video");n.id=this.getElementId(),n.srcObject=e,n.width=t.clientWidth,n.height=t.clientHeight,n.style.touchAction="none",n.autoplay=!0,n.setAttribute("playsinline","playsinline"),n.onclick=()=>{n.play(),this._client._audioComponent._audioRender.play()};const i=(e,t)=>{n.requestVideoFrameCallback(i),this._videoFps.count(),this._client.getChannelProcessor("input").addProcessedFrame({serverDataKey:t.rtpTimestamp,firstFramePacketArrivalTimeMs:t.receiveTime,frameSubmittedTimeMs:t.receiveTime,frameDecodedTimeMs:t.expectedDisplayTime,frameRenderedTimeMs:t.expectedDisplayTime})};n.requestVideoFrameCallback(i),this._videoRender=n,t.appendChild(n),this._videoFps.start(),n.addEventListener("pointermove",(e=>this._client.getChannelProcessor("input").onPointerMove(e)),{passive:!1}),n.addEventListener("pointerdown",(e=>this._client.getChannelProcessor("input").onPointerClick(e)),{passive:!1}),n.addEventListener("pointerup",(e=>this._client.getChannelProcessor("input").onPointerClick(e)),{passive:!1}),n.addEventListener("wheel",(e=>this._client.getChannelProcessor("input").onPointerScroll(e)),{passive:!1}),window.addEventListener("keydown",(e=>{this._client.getChannelProcessor("input").onKeyDown(e)})),window.addEventListener("keyup",(e=>{this._client.getChannelProcessor("input").onKeyUp(e)})),n.play().then((()=>{})).catch((e=>{console.log("xCloudPlayer Component/Video.ts - Error executing play() on videoRender:",e)}))}else console.log("xCloudPlayer Component/Video.ts - Error fetching videoholder: div#"+this._client._elementHolder);console.log("xCloudPlayer Component/Video.ts - Media element created")}getElementId(){return"xCloudPlayer_"+this._client._elementHolderRandom+"_videoRender"}getSource(){return this._videoSource}createMediaSource(){const e=new MediaSource,t=window.URL.createObjectURL(e);return e.addEventListener("sourceopen",(()=>{console.log("xCloudPlayer Component/Video.ts - MediaSource opened. Attaching videoSourceBuffer...");const t=e.addSourceBuffer('video/mp4; codecs="avc1.42c020"');t.mode="sequence",t.addEventListener("error",(e=>{console.log("xCloudPlayer Component/Video.ts - Error video...",e)})),this._videoSource=t})),this._mediaSource=e,t}destroy(){var e;this._videoFps.stop(),delete this._mediaSource,delete this._videoRender,delete this._videoSource,null===(e=document.getElementById(this.getElementId()))||void 0===e||e.remove(),console.log("xCloudPlayer Component/Video.ts - Cleaning up Video element")}}},557:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this._application=null,this._gamepads=[],this._activeGamepadIndex=-1,this._shadowGamepad={0:{A:0,B:0,X:0,Y:0,LeftShoulder:0,RightShoulder:0,LeftTrigger:0,RightTrigger:0,View:0,Menu:0,LeftThumb:0,RightThumb:0,DPadUp:0,DPadDown:0,DPadLeft:0,DPadRight:0,Nexus:0,LeftThumbXAxis:0,LeftThumbYAxis:0,RightThumbXAxis:0,RightThumbYAxis:0}}}setApplication(e){this._application=e}start(){}stop(){}pressButton(e,t){var n;this._shadowGamepad[e][t]=1,null===(n=this._application)||void 0===n||n.getChannelProcessor("input").queueGamepadState(this._shadowGamepad[e]),setTimeout((()=>{var n;this._shadowGamepad[e][t]=0,null===(n=this._application)||void 0===n||n.getChannelProcessor("input").queueGamepadState(this._shadowGamepad[e])}),60)}setInput(e){var t;this._shadowGamepad[0]=e,null===(t=this._application)||void 0===t||t.getChannelProcessor("input").queueGamepadState(this._shadowGamepad[0])}run(){var e;null===(e=this._application)||void 0===e||e.getChannelProcessor("input").queueGamepadState(this.requestState()),requestAnimationFrame((()=>{this.run()}))}requestState(){const e=navigator.getGamepads();let t=!1;for(let n=0;n<e.length;n++){const i=e[n];if(null!==i&&i.connected&&(-1===this._activeGamepadIndex&&i.buttons.some((e=>e.value>=.75))&&(this._activeGamepadIndex=i.index),i.index===this._activeGamepadIndex)){t=!0;const e=this.mapStateLabels(i.buttons,i.axes);return e.GamepadIndex=0,e}}return t||(this._activeGamepadIndex=-1),null}mapStateLabels(e,t){var n,i,s,o,r,a,l,d,h,u,c,p,m,v,_,g,f,y,b;return{A:(null===(n=e[0])||void 0===n?void 0:n.value)||this._shadowGamepad[0].A||0,B:(null===(i=e[1])||void 0===i?void 0:i.value)||this._shadowGamepad[0].B||0,X:(null===(s=e[2])||void 0===s?void 0:s.value)||this._shadowGamepad[0].X||0,Y:(null===(o=e[3])||void 0===o?void 0:o.value)||this._shadowGamepad[0].Y||0,LeftShoulder:(null===(r=e[4])||void 0===r?void 0:r.value)||0,RightShoulder:(null===(a=e[5])||void 0===a?void 0:a.value)||0,LeftTrigger:(null===(l=e[6])||void 0===l?void 0:l.value)||0,RightTrigger:(null===(d=e[7])||void 0===d?void 0:d.value)||0,View:(null===(h=e[8])||void 0===h?void 0:h.value)||0,Menu:(null===(u=e[9])||void 0===u?void 0:u.value)||0,LeftThumb:(null===(c=e[10])||void 0===c?void 0:c.value)||0,RightThumb:(null===(p=e[11])||void 0===p?void 0:p.value)||0,DPadUp:(null===(m=e[12])||void 0===m?void 0:m.value)||0,DPadDown:(null===(v=e[13])||void 0===v?void 0:v.value)||0,DPadLeft:(null===(_=e[14])||void 0===_?void 0:_.value)||0,DPadRight:(null===(g=e[15])||void 0===g?void 0:g.value)||0,Nexus:(null===(f=e[16])||void 0===f?void 0:f.value)||(null===(y=e[8])||void 0===y?void 0:y.value)&&(null===(b=e[9])||void 0===b?void 0:b.value)||this._shadowGamepad[0].Nexus||0,LeftThumbXAxis:t[0],LeftThumbYAxis:t[1],RightThumbXAxis:t[2],RightThumbYAxis:t[3]}}}},602:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this._keyboardState={GamepadIndex:0,Nexus:0,Menu:0,View:0,A:0,B:0,X:0,Y:0,DPadUp:0,DPadDown:0,DPadLeft:0,DPadRight:0,LeftShoulder:0,RightShoulder:0,LeftThumb:0,RightThumb:0,LeftThumbXAxis:0,LeftThumbYAxis:0,RightThumbXAxis:0,RightThumbYAxis:0,LeftTrigger:0,RightTrigger:0},this._downFunc=e=>{this.onKeyChange(e,!0)},this._upFunc=e=>{this.onKeyChange(e,!1)}}start(){window.addEventListener("keydown",this._downFunc),window.addEventListener("keyup",this._upFunc)}stop(){window.removeEventListener("keydown",this._downFunc),window.removeEventListener("keyup",this._upFunc)}onKeyDown(e){this.onKeyChange(e,!0)}onKeyUp(e){this.onKeyChange(e,!1)}onKeyChange(e,t){const n=t?1:0;switch(e.keyCode){case 37:this._keyboardState.DPadLeft=n;break;case 38:this._keyboardState.DPadUp=n;break;case 39:this._keyboardState.DPadRight=n;break;case 40:this._keyboardState.DPadDown=n;break;case 13:case 65:this._keyboardState.A=n;break;case 8:case 66:this._keyboardState.B=n;break;case 88:this._keyboardState.X=n;break;case 89:this._keyboardState.Y=n;break;case 219:this._keyboardState.LeftShoulder=n;break;case 221:this._keyboardState.RightShoulder=n;break;case 86:this._keyboardState.View=n;break;case 77:this._keyboardState.Menu=n;break;case 78:this._keyboardState.Nexus=n;break;case 189:this._keyboardState.LeftTrigger=n;break;case 187:this._keyboardState.RightTrigger=n}}requestState(){return this._keyboardState}pressButton(e){this._keyboardState[e]=!0,setTimeout((()=>{this._keyboardState[e]=!1}),60)}}},174:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(370));class o extends s.default{}t.default=o},758:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t){this._counter=0,this._name=t,this._application=e}start(){this._eventInterval=setInterval((()=>{this._application.getEventBus().emit("fps_"+this._name,{fps:this._counter}),this._counter=0}),1e3)}stop(){clearInterval(this._eventInterval)}count(){this._counter++}}},516:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.xCloudPlayerBackend=void 0;const s=i(n(272)),o=i(n(91)),r=i(n(187)),a=i(n(223)),l=i(n(684)),d=i(n(191)),h=i(n(174)),u=i(n(557)),c=i(n(602));t.xCloudPlayerBackend=class{constructor(){this._config={locale:"en-US"},this.sessionId=""}setSessionId(e){this.sessionId=e}getConsoles(){return this.readBody(fetch("/v6/servers/home"))}startSession(e,t){return new Promise(((n,i)=>{this.readBody(fetch("/v5/sessions/"+e+"/play",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({clientSessionId:"",titleId:"cloud"===e?t:"",systemUpdateGroup:"",settings:{nanoVersion:"V3;WebrtcTransport.dll",enableTextToSpeech:!1,highContrast:0,locale:this._config.locale,useIceConnection:!1,timezoneOffsetMinutes:120,sdkType:"web",osName:"windows"},serverId:"home"===e?t:"",fallbackRegionNames:[]})})).then((e=>{console.log("Started streaming session:",e.sessionId),this.setSessionId(e.sessionId),this.waitState().then((()=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/configuration")).then((e=>{n(e)})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))}))}waitState(){return new Promise(((e,t)=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/state")).then((n=>{switch(n.state){case"Provisioned":e(n);break;case"Provisioning":setTimeout((()=>{this.waitState().then((t=>{e(t)})).catch((e=>{t(e)}))}),2e3);break;default:console.log("unknown state:",n)}})).catch((e=>{t(e)}))}))}sendSDPOffer(e){return new Promise(((t,n)=>{fetch("/v5/sessions/home/"+this.sessionId+"/sdp",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({messageType:"offer",requestId:1,sdp:e.sdp,configuration:{containerizeAudio:!1,chatConfiguration:{bytesPerSample:2,expectedClipDurationMs:20,format:{codec:"opus",container:"webm"},numChannels:1,sampleFrequencyHz:24e3},chat:{minVersion:1,maxVersion:1},chatStream:{minVersion:1,maxVersion:1},control:{minVersion:1,maxVersion:3},input:{minVersion:1,maxVersion:8},message:{minVersion:1,maxVersion:1}}})}).then((e=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/sdp")).then((e=>{if("retry"===e){const e=setInterval((()=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/sdp")).then((n=>{"retry"!==n&&(t(n),clearInterval(e))})).catch((t=>{n(t),clearInterval(e)}))}),1e3)}t(e)})).catch((e=>{n(e)}))})).catch((e=>{n(e)}))}))}sendSDPChatOffer(e){return new Promise(((t,n)=>{fetch("/v5/sessions/home/"+this.sessionId+"/sdp",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({messageType:"offer",requestId:2,sdp:e.sdp,configuration:{isMediaStreamsChatRenegotiation:!0}})}).then((e=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/sdp")).then((e=>{if("retry"===e){const e=setInterval((()=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/sdp")).then((n=>{"retry"!==n&&(t(n),clearInterval(e))})).catch((t=>{n(t),clearInterval(e)}))}),1e3)}t(e)})).catch((e=>{n(e)}))})).catch((e=>{n(e)}))}))}sendICECandidates(e){return new Promise(((t,n)=>{fetch("/v5/sessions/home/"+this.sessionId+"/ice",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({iceCandidates:e})}).then((()=>{this.readBody(fetch("/v5/sessions/home/"+this.sessionId+"/ice")).then((e=>{t(e)})).catch((e=>{n(e)}))})).catch((e=>{n(e)}))}))}readBody(e){return new Promise(((t,n)=>{e.then((e=>{204===e.status?t("retry"):e.json().then((e=>{t(e)})).catch((e=>{n({error:e})}))}))}))}},t.default=class{constructor(e,t={}){this._isResetting=!1,this._webrtcConfiguration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},this._webrtcDataChannelsConfig={input:{ordered:!0,protocol:"1.0"},chat:{protocol:"chatV1"},control:{protocol:"controlV1"},message:{protocol:"messageV1"}},this._webrtcStates={iceGathering:"open",iceConnection:"open",iceCandidates:[],streamConnection:"open"},this._webrtcDataChannels={},this._webrtcChannelProcessors={},this._iceCandidates=[],this._inputDriver=void 0,this._codecPreference="",this._maxVideoBitrate=0,this._maxAudioBitrate=0,console.log("xCloudPlayer loaded!"),this._config=Object.assign({input_touch:!1,input_mousekeyboard:!1,input_legacykeyboard:!0},t),this._eventBus=new h.default,this._elementHolder=e,this._elementHolderRandom=Math.floor(100*Math.random())+1,this._webrtcClient=new RTCPeerConnection(this._webrtcConfiguration),this._openDataChannels(),void 0===this._config.input_driver?this._inputDriver=new u.default:null!==this._config.input_driver&&(this._inputDriver=this._config.input_driver),this._inputDriver.setApplication(this),this._keyboardDriver=new c.default,this._gatherIce(),this._webrtcClient.ontrack=e=>{"video"===e.track.kind?(this._videoComponent=new l.default(this),this._videoComponent.create(e.streams[0])):"audio"===e.track.kind?(this._audioComponent=new d.default(this),this._audioComponent.create(e.streams[0])):console.log("Unknown Track kind: ",e.track.kind)},this._webrtcClient.addTransceiver("audio",{direction:"sendrecv"}),this._webrtcClient.addTransceiver("video",{direction:"recvonly"})}createOffer(){return new Promise((e=>{this._inputDriver.start(),this._keyboardDriver.start(),this.getEventBus().emit("connectionstate",{state:"new"}),""!==this._codecPreference&&(console.log("xCloudPlayer Library.ts - createOffer() Set codec preference mimetype to:",this._codecPreference),this._setCodec(this._codecPreference)),this._webrtcClient.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((t=>{var n;this._maxVideoBitrate>0&&(console.log("xCloudPlayer Library.ts - createOffer() Set max video bitrate to:",this._maxVideoBitrate,"kbps"),t.sdp=this._setBitrate(t.sdp,"video",this._maxVideoBitrate)),this._maxAudioBitrate>0&&(console.log("xCloudPlayer Library.ts - createOffer() Set max audio bitrate to:",this._maxVideoBitrate,"kbps"),t.sdp=this._setBitrate(t.sdp,"audio",this._maxAudioBitrate)),!0!==(this._config.sound_force_mono||!1)&&(console.log("xCloudPlayer Library.ts - createOffer() Set audio to stereo"),t.sdp=null===(n=t.sdp)||void 0===n?void 0:n.replace("useinbandfec=1","useinbandfec=1; stereo=1")),this._webrtcClient.setLocalDescription(t),e(t)}))}))}sdpNegotiationChat(){this.createOffer().then((e=>{this._sdpHandler(this,e)}))}setSdpHandler(e){this._sdpHandler=e}setAudioBitrate(e){this._maxAudioBitrate=e}setVideoBitrate(e){this._maxVideoBitrate=e}setControllerRumble(e){this.getChannelProcessor("input")._rumbleEnabled=e}_setBitrate(e,t,n){const i=e.split("\n");let s=-1;for(let e=0;e<i.length;e++)if(0===i[e].indexOf("m="+t)){s=e;break}if(-1===s)return console.debug("Could not find the m line for",t),e;for(s++;0===i[s].indexOf("i=")||0===i[s].indexOf("c=");)s++;if(0===i[s].indexOf("b"))return i[s]="b=AS:"+n,i.join("\n");let o=i.slice(0,s);return o.push("b=AS:"+n),o=o.concat(i.slice(s,i.length)),o.join("\n")}setCodecPreferences(e){this._codecPreference=e}_setCodec(e){const t=this._webrtcClient.getTransceivers()[1],n=RTCRtpReceiver.getCapabilities("video");if(null===n)console.log("xCloudPlayer Library.ts - _setCodec() Failed to get video codecs");else{const i=n.codecs,s=[];for(let t=0;t<i.length;t++)i[t].mimeType===e&&(console.log("xCloudPlayer Library.ts - Adding codec as preference:",i[t]),s.push(i[t]));0===s.length&&console.log("xCloudPlayer Library.ts - _setCodec() No video codec matches with mimetype:",e),void 0!==t.setCodecPreferences?t.setCodecPreferences(s):console.log("xCloudPlayer Library.ts - _setCodec() Browser does not support setCodecPreferences()")}}setRemoteOffer(e){try{this._webrtcClient.setRemoteDescription({type:"answer",sdp:e})}catch(t){console.log("xCloudPlayer Library.ts - setRemoteOffer() Remote SDP is not valid:",e)}this.getEventBus().emit("connectionstate",{state:"connecting"})}reset(){if(!this._isResetting){this._isResetting=!0,this._webrtcClient.close();for(const e in this._webrtcChannelProcessors)this._webrtcChannelProcessors[e].destroy();this._inputDriver.stop(),this._keyboardDriver.stop(),this._webrtcClient=new RTCPeerConnection(this._webrtcConfiguration),this._openDataChannels(),this._inputDriver.start(),this._keyboardDriver.start(),this._gatherIce(),this._isResetting=!1}}getIceCandidates(){return this._iceCandidates}setIceCandidates(e){for(const t in e)"a=end-of-candidates"===e[t].candidate&&(e[t].candidate=""),this._webrtcClient.addIceCandidate({candidate:e[t].candidate,sdpMid:e[t].sdpMid,sdpMLineIndex:e[t].sdpMLineIndex})}getChannel(e){return this._webrtcDataChannels[e]}_openDataChannels(){for(const e in this._webrtcDataChannelsConfig)this._openDataChannel(e,this._webrtcDataChannelsConfig[e])}_openDataChannel(e,t){switch(console.log("xCloudPlayer Library.ts - Creating data channel:",e,t),this._webrtcDataChannels[e]=this._webrtcClient.createDataChannel(e,t),e){case"input":this._webrtcChannelProcessors[e]=new s.default("input",this);break;case"control":this._webrtcChannelProcessors[e]=new o.default("control",this);break;case"chat":this._webrtcChannelProcessors[e]=new a.default("chat",this);break;case"message":this._webrtcChannelProcessors[e]=new r.default("message",this)}this._webrtcDataChannels[e].addEventListener("open",(t=>{void 0!==this._webrtcChannelProcessors[e]&&void 0!==this._webrtcChannelProcessors[e].onOpen?this._webrtcChannelProcessors[e].onOpen(t):console.log("xCloudPlayer Library.ts - ["+e+"] Got open channel:",t)})),this._webrtcDataChannels[e].addEventListener("message",(t=>{void 0!==this._webrtcChannelProcessors[e]&&void 0!==this._webrtcChannelProcessors[e].onMessage?this._webrtcChannelProcessors[e].onMessage(t):console.log("xCloudPlayer Library.ts - ["+e+"] Received channel message:",t)})),this._webrtcDataChannels[e].addEventListener("closing",(t=>{void 0!==this._webrtcChannelProcessors[e]&&void 0!==this._webrtcChannelProcessors[e].onClosing?this._webrtcChannelProcessors[e].onClosing(t):console.log("xCloudPlayer Library.ts - ["+e+"] Got closing channel:",t)})),this._webrtcDataChannels[e].addEventListener("close",(t=>{void 0!==this._webrtcChannelProcessors[e]&&void 0!==this._webrtcChannelProcessors[e].onClose?this._webrtcChannelProcessors[e].onClose(t):console.log("xCloudPlayer Library.ts - ["+e+"] Got close channel:",t)})),this._webrtcDataChannels[e].addEventListener("error",(t=>{void 0!==this._webrtcChannelProcessors[e]&&void 0!==this._webrtcChannelProcessors[e].onError?this._webrtcChannelProcessors[e].onError(t):console.log("xCloudPlayer Library.ts - ["+e+"] Got error channel:",t)})),"input"===e&&this._webrtcChannelProcessors[e].addEventListener("state",(t=>{this._webrtcStates.streamConnection=t.state,this.getEventBus().emit("connectionstate",{state:t.state}),console.log("xCloudPlayer Library.ts - ["+e+"] Channel state changed to:",t)}))}_gatherIce(){this._webrtcClient.addEventListener("icecandidate",(e=>{e.candidate&&(console.log("xCloudPlayer Library.ts - ICE candidate found:",e.candidate),this._iceCandidates.push(e.candidate))}))}getDataChannel(e){return this._webrtcDataChannels[e]}getChannelProcessor(e){return this._webrtcChannelProcessors[e]}getEventBus(){return this._eventBus}setGamepadInput(e){this.getChannelProcessor("input").setInput(e)}}}},t={},n=function n(i){var s=t[i];if(void 0!==s)return s.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}(516);xCloudPlayer=n})();